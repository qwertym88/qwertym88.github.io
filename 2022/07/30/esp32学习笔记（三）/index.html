<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="esp32学习笔记（三）"><meta name="keywords" content="esp32"><meta name="author" content="石海鹏,undefined"><meta name="copyright" content="石海鹏"><title>esp32学习笔记（三） | 石海鹏的网页</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?135fb72c1ba680bd194f7e2d3949657d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BLE-Client代码"><span class="toc-number">2.</span> <span class="toc-text">BLE Client代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#扫描"><span class="toc-number">2.1.</span> <span class="toc-text">扫描</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#连接"><span class="toc-number">2.2.</span> <span class="toc-text">连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用"><span class="toc-number">2.3.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">3.</span> <span class="toc-text">测试</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://ws1.sinaimg.cn/thumbnail/0072Lfvtly1fz3tcisykvj30nb0nb0z8.jpg"></div><div class="author-info__name text-center">石海鹏</div><div class="author-info__description text-center">编程辅导&amp;交流</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">9</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">5</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://github.com/shihaipeng" target="_blank">github</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">石海鹏的网页</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">esp32学习笔记（三）</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-07-30</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/笔记/">笔记</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇紧接上一篇，写esp32作为ble client的使用方法。当然，同样涉及了特别多的知识，包括对之前的一些补充。只能说这个东西竟会如此复杂，简直远远超出了我之前对它的预期。<br><a id="more"></a></p>
<h2 id="BLE-Client代码"><a href="#BLE-Client代码" class="headerlink" title="BLE Client代码"></a>BLE Client代码</h2><p>你别说，这个的代码还真少，基本找不到。唯一的参考就是官方提供的示例了。不过那个官方示例讲了等于是没讲，不要太指望它。经过我漫长的研究，我逐渐明白了这个示例的具体逻辑。不过在试图仿写的过程中踩了两个超级大坑，之后会提到。<br>要连接一个设备，一共需要以下三个步骤：</p>
<ol>
<li>扫描周边设备</li>
<li>连接指定设备</li>
<li>通讯</li>
</ol>
<h3 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h3><p>扫描部分单看还算简单，开始扫描就这么写：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setup</span></span><br><span class="line">BLEDevice::init(<span class="string">""</span>); <span class="comment">// 写名字也可以，无关紧要</span></span><br><span class="line">BLEScan *pScan = BLEDevice::getScan();</span><br><span class="line">pScan-&gt;setActiveScan(<span class="literal">true</span>);</span><br><span class="line">pScan-&gt;setAdvertisedDeviceCallbacks(<span class="keyword">new</span> MyAdvertisedDeviceCallbacks());</span><br><span class="line">pScan-&gt;start(<span class="number">30</span>); <span class="comment">// 单位：秒，自动结束</span></span><br></pre></td></tr></table></figure></p>
<p>其中，扫描方式分为两种，分别为<code>Active Scan</code>和<code>Passive Scan</code>。为了区分这两个，我们就得介绍一下广播（advertising）和扫描（scaning）之间的数据交换了。首先，广播的设备会发送两种性质的数据文件，一种叫Advertising Data，一个叫做Scan Response Data。下图就是一个典型的例子。<br><img src="/2022/07/30/esp32学习笔记（三）/1.jpg"><br>Advertising Data就是这个ble设备自动向外界发送的信息，其中最重要的就是图中所示的flag。它可以标识这个蓝牙设备是否可接入/可被扫描到。如何理解这一点？我们可以想一些实际生活中的例子。比如要用蓝牙实现“人机分离10m自动爆炸”，那么手机就是一个server，探测器就是一个client。实际需求中我们并不需要真正和这个探测器连接，所以flag设计成可被扫描/不可接入便非常的合理。不然每次你要用手机连接你的蓝牙耳机时，一扫描就会冒出这个探测器的蓝牙地址（电脑、手机检测的蓝牙设备都是默认筛除了那些不可接入的），看着也心烦。尤其是如果你家里有特别多的这种检测器，你肯定不想一开手机蓝牙就全自动连接上了。我这里因为要建立连接，所以这么设置了（否则不会被检测到的）。<br>顺带一提，Advertising Data事实上还可以发其他数据。不过没用。下面的才有用。<br>Scan Response Data就是标识为scanable的设备被扫描后，发送给做出扫描动作的设备的回应。一般而言，我们需要获取的最主要的信息就是被扫描出来的设备的名称。有的设备还会发送自己的service uuid用来告诉对方本机有哪些功能。事实上这很容易理解，我找人，你却连自己名字都不愿意告诉我，那我怎么找到你？因此，Advertising Data中的flag和这个的Local Name都是很重要的，一般都不能省略。<br><code>Active Scan</code>就是每次扫描都会收到Scan Response Data，而且貌似速度更快；<code>Passive Scan</code>就是不接收Scan Response Data。一般而言，我们都会用前者。<br>回想上一章我们用esp32，我们好像当作server的时候，好像并没有太注意advertise的内容，我们直接调用，程序自动就会设置好我们想要的。确实，作为一个server，不需要考虑这部分的内容（或者说相较于其本职，这显得无足轻重），程序自动就会设置为可连接，被扫描后就会发送自己的名字。但事实上我们也可以自己调整，比如说，我在Scan Response Data中加上service uuid，如下例：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();</span><br><span class="line">pAdvertising-&gt;addServiceUUID(SERVICE_UUID);<span class="comment">// 添加uuid</span></span><br><span class="line"></span><br><span class="line">pServer-&gt;getAdvertising()-&gt;start(); <span class="comment">// 开始广播</span></span><br></pre></td></tr></table></figure></p>
<p>其他的怎么设置我就没有深入研究了，有需要自己看源码去。</p>
<p>回到代码，接下来我们需要设置回调。回调写法如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAdvertisedDeviceCallbacks</span> :</span> <span class="keyword">public</span> BLEAdvertisedDeviceCallbacks</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onResult</span><span class="params">(BLEAdvertisedDevice device)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    Serial.print(<span class="string">"BLE Advertised Device found: "</span>);</span><br><span class="line">    Serial.println(device.toString().c_str());      <span class="comment">// 打印扫描出的设备信息</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (device.getName() == <span class="string">"BLEClient"</span>)            <span class="comment">// 如果名字是我们要找的，就把信息记录下来</span></span><br><span class="line">    &#123;</span><br><span class="line">      device.getScan()-&gt;stop(); <span class="comment">// 停止扫描</span></span><br><span class="line">      foundDevice = <span class="literal">true</span>;</span><br><span class="line">      pDevice = <span class="keyword">new</span> BLEAdvertisedDevice(device);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里，BLEAdvertisedDevice记录了扫描出设备的信息，主要包括ip，Scan Response Data。其中，getName就是得到Scan Response Data里发送的name（如果不发送就是空，其他数据都同理）。这里注意，第一个大坑出现了。<strong>一定不能在这里连接蓝牙设备，不然这个程序压根不会运行，而且没有任何报错</strong>。怎么理解呢，或许是因为不能在回调里做太多事情吧。<strong>要连接server，只能在这里先记下‘已发现目标’，再到loop函数里面连接</strong>。</p>
<h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><p>连接事实上还简单。大概长这样：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> <span class="comment">// 必须在loop函数里连接</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (foundDevice)</span><br><span class="line">  &#123;</span><br><span class="line">    connect(pDevice);</span><br><span class="line">    foundDevice = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">(BLEAdvertisedDevice *target)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  pClient = BLEDevice::createClient();</span><br><span class="line">  <span class="comment">// pClient-&gt;setClientCallbacks(new MyClientCallback());</span></span><br><span class="line">  <span class="keyword">if</span> (pClient-&gt;connect(target))</span><br><span class="line">  &#123;</span><br><span class="line">    pClient-&gt;setMTU(<span class="number">517</span>);</span><br><span class="line">    getServiceId(pClient);</span><br><span class="line">    getCharaceristicId(pService);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里注意<code>pClient-&gt;setMTU(517);</code>这一句。强烈建议都写上，管他有没有用。MTU我不太了解，可能会说错。这个是单词通讯容许的最大字节数。比如在做write和notify操作时，就会需要这个。当时我手机做client、写手机app的时候，并没有太注意这一点。当时好像没有改这个，导致每次只能写20字节到esp32上（虽然知道整个项目完工，我都不需要一次发送20字节以上的数据，所以压根没有发现）。两个ble通讯，单次最大取两个的MTU最小值。之后的我不怎么清楚，以下都是我瞎猜的。write事实上不受影响，android和esp32都设置地特别大。但如果你想用notify来传递信息的话，esp32默认23字节，android也默认23（ios好像100多），你得把两个都改了。这个取值范围就是23到517。对于日常编程来讲，我觉得既然都不咋见的会有什么不良影响，不如无脑写上，免得万一用上了还找不出来是这里的问题。<br>然后是setClientCallbacks。一眼丁真，鉴定为典中典。不过好像貌似并没有什么用，尤其是那个onConnect。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClientCallback</span> :</span> <span class="keyword">public</span> BLEClientCallbacks</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onConnect</span><span class="params">(BLEClient *pclient)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    Serial.println(<span class="string">"Connect!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onDisconnect</span><span class="params">(BLEClient *pclient)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    Serial.println(<span class="string">"Disconnect!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>接下来是找service/characteristic uuid。这个样子找就对了。为了方便查看，专门独立出来。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用client找service，service里面找characteristic</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getServiceId</span><span class="params">(BLEClient *client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 列举所有的service</span></span><br><span class="line">  <span class="comment">// std::map&lt;std::__cxx11::string, BLERemoteService *&gt; *serviceMap = client-&gt;getServices();</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i : *(client-&gt;getServices()))</span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(i.second-&gt;toString().c_str());</span><br><span class="line">    <span class="comment">// 获取其中的某一个</span></span><br><span class="line">    <span class="keyword">if</span> (i.first == <span class="string">"4fafc201-1fb5-459e-8fcc-c5c9c331914b"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      pService = i.second;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 或直接 pService = client-&gt;getService(ServiceUUID); 点杀</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getCharaceristicId</span><span class="params">(BLERemoteService *service)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (service == <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(<span class="string">"Targeted Service Not Found!"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::__cxx11::<span class="built_in">string</span>, BLERemoteCharacteristic *&gt; *charaMap = service-&gt;getCharacteristics();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i : *charaMap)</span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(i.second-&gt;toString().c_str());</span><br><span class="line">    <span class="keyword">if</span> (i.second-&gt;canRead()) <span class="comment">// 一个偷懒的方法</span></span><br><span class="line">      pReadChara = i.second;</span><br><span class="line">    <span class="keyword">if</span> (i.second-&gt;canNotify())</span><br><span class="line">      pNotifyChara = i.second;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 或直接 pReadChara = service-&gt;getCharacteristic(ReadCharacteristicUUID);</span></span><br><span class="line">  <span class="comment">// 总之找个合理的方式把几个特征值划分了就行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>这里只讲notify。大概长这样：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// loop</span></span><br><span class="line">pNotifyChara-&gt;registerForNotify(notifyCallback);</span><br><span class="line"></span><br><span class="line"><span class="comment">//global</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notifyCallback</span><span class="params">(BLERemoteCharacteristic *pBLERemoteCharacteristic, <span class="keyword">uint8_t</span> *pData, <span class="keyword">size_t</span> length, <span class="keyword">bool</span> isNotify)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Serial.print(<span class="string">"Notify callback for characteristic "</span>);</span><br><span class="line">  Serial.print(pBLERemoteCharacteristic-&gt;getUUID().toString().c_str());</span><br><span class="line">  Serial.print(<span class="string">" of data length "</span>);</span><br><span class="line">  Serial.println(length);</span><br><span class="line">  Serial.print(<span class="string">"data: "</span>);</span><br><span class="line">  Serial.write(pData, length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意这里有一个小坑。pData是覆盖式的，不会清空。比如说你前一个是10字节的数据”abcdefghij”，下一次是6字节的”123456”，那么pData就会变成”123456ghij”。因此注意length的大小十分重要。不过如果你只是做个测试，就照着上面的写就行，效果非常好。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>第二个大坑出现了。我发现我不会用nRF Connect。<br>首先你要打开Configure GATT server，然后New GATT configeration，然后搞成这样。这就是你这个server的信息了。<br><img src="/2022/07/30/esp32学习笔记（三）/2.jpg"><br>然后在advertiser下编辑advertise所需的信息，大概如前文所示，重点是Advertising Data的flag和Scan Response Data的name。然后右上角铅笔编辑此设备蓝牙名称（默认的也可以，就是有点长）。弄完之后大概会长这样：<br><img src="/2022/07/30/esp32学习笔记（三）/3.jpg"><br>然后烧写代码，名字匹配就会自动连接。接下来就可以愉快地玩耍了。<br>完整版代码如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Arduino.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;BLEDevice.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> foundDevice = <span class="literal">false</span>;</span><br><span class="line">BLEAdvertisedDevice *pDevice = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">bool</span> CONNECTED = <span class="literal">false</span>;</span><br><span class="line">BLEClient *pClient;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">(BLEAdvertisedDevice *)</span></span>;</span><br><span class="line"></span><br><span class="line">BLERemoteService *pService = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getServiceId</span><span class="params">(BLEClient *)</span></span>;</span><br><span class="line"></span><br><span class="line">BLERemoteCharacteristic *pReadChara = <span class="literal">nullptr</span>;</span><br><span class="line">BLERemoteCharacteristic *pNotifyChara = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getCharaceristicId</span><span class="params">(BLERemoteService *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClientCallback</span> :</span> <span class="keyword">public</span> BLEClientCallbacks</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onConnect</span><span class="params">(BLEClient *pclient)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    CONNECTED = <span class="literal">true</span>;</span><br><span class="line">    Serial.println(<span class="string">"Connect!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onDisconnect</span><span class="params">(BLEClient *pclient)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    CONNECTED = <span class="literal">false</span>;</span><br><span class="line">    Serial.println(<span class="string">"Disconnect!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAdvertisedDeviceCallbacks</span> :</span> <span class="keyword">public</span> BLEAdvertisedDeviceCallbacks</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onResult</span><span class="params">(BLEAdvertisedDevice device)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    Serial.print(<span class="string">"BLE Advertised Device found: "</span>);</span><br><span class="line">    Serial.println(device.toString().c_str());</span><br><span class="line">    <span class="keyword">if</span> (device.getName() == <span class="string">"BLEClient"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      device.getScan()-&gt;stop();</span><br><span class="line">      foundDevice = <span class="literal">true</span>;</span><br><span class="line">      pDevice = <span class="keyword">new</span> BLEAdvertisedDevice(device);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">(BLEAdvertisedDevice *target)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  pClient = BLEDevice::createClient();</span><br><span class="line">  pClient-&gt;setClientCallbacks(<span class="keyword">new</span> MyClientCallback());</span><br><span class="line">  <span class="keyword">if</span> (pClient-&gt;connect(target))</span><br><span class="line">  &#123;</span><br><span class="line">    pClient-&gt;setMTU(<span class="number">517</span>);</span><br><span class="line">    getServiceId(pClient);</span><br><span class="line">    getCharaceristicId(pService);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getServiceId</span><span class="params">(BLEClient *client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 列举所有的service</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::__cxx11::<span class="built_in">string</span>, BLERemoteService *&gt; *serviceMap = client-&gt;getServices();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i : *(client-&gt;getServices()))</span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(i.second-&gt;toString().c_str());</span><br><span class="line">    <span class="comment">// 获取其中的某一个</span></span><br><span class="line">    <span class="keyword">if</span> (i.first == <span class="string">"4fafc201-1fb5-459e-8fcc-c5c9c331914b"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      pService = i.second;</span><br><span class="line">      <span class="comment">// 或直接 pService = client-&gt;getService(ServiceUUID);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notifyCallback</span><span class="params">(BLERemoteCharacteristic *pBLERemoteCharacteristic, <span class="keyword">uint8_t</span> *pData, <span class="keyword">size_t</span> length, <span class="keyword">bool</span> isNotify)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Serial.print(<span class="string">"Notify callback for characteristic "</span>);</span><br><span class="line">  Serial.print(pBLERemoteCharacteristic-&gt;getUUID().toString().c_str());</span><br><span class="line">  Serial.print(<span class="string">" of data length "</span>);</span><br><span class="line">  Serial.println(length);</span><br><span class="line">  Serial.print(<span class="string">"data: "</span>);</span><br><span class="line">  Serial.write(pData, length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getCharaceristicId</span><span class="params">(BLERemoteService *service)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (service == <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(<span class="string">"Targeted Service Not Found!"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::__cxx11::<span class="built_in">string</span>, BLERemoteCharacteristic *&gt; *charaMap = service-&gt;getCharacteristics();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i : *charaMap)</span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(i.second-&gt;toString().c_str());</span><br><span class="line">    <span class="keyword">if</span> (i.second-&gt;canRead())</span><br><span class="line">      pReadChara = i.second;</span><br><span class="line">    <span class="keyword">if</span> (i.second-&gt;canNotify())</span><br><span class="line">      pNotifyChara = i.second;</span><br><span class="line">    <span class="comment">// 或直接 pReadChara = service-&gt;getCharacteristic(ReadCharacteristicUUID);</span></span><br><span class="line">    <span class="comment">// 总之找个合理的方式把几个特征值划分了就行</span></span><br><span class="line">  &#125;</span><br><span class="line">  pNotifyChara-&gt;registerForNotify(notifyCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line"></span><br><span class="line">  BLEDevice::init(<span class="string">"esp32 server"</span>);</span><br><span class="line"></span><br><span class="line">  BLEScan *pScan = BLEDevice::getScan();</span><br><span class="line">  pScan-&gt;setActiveScan(<span class="literal">true</span>);</span><br><span class="line">  pScan-&gt;setAdvertisedDeviceCallbacks(<span class="keyword">new</span> MyAdvertisedDeviceCallbacks());</span><br><span class="line">  pScan-&gt;start(<span class="number">30</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (foundDevice)</span><br><span class="line">  &#123;</span><br><span class="line">    connect(pDevice);</span><br><span class="line">    foundDevice = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/esp32/">esp32</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2022/07/29/esp32学习笔记（二）/"><span>esp32学习笔记（二）</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="lv-container" data-id="city" data-uid="MTAyMC80MjExNS8xODY2Mg=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By 石海鹏</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">随便写的，不要在意....</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>