<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="esp32学习笔记（四）"><meta name="keywords" content="esp32"><meta name="author" content="石海鹏,undefined"><meta name="copyright" content="石海鹏"><title>esp32学习笔记（四） | 石海鹏的网页</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?135fb72c1ba680bd194f7e2d3949657d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#esp-now简介"><span class="toc-number">2.</span> <span class="toc-text">esp-now简介</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://ws1.sinaimg.cn/thumbnail/0072Lfvtly1fz3tcisykvj30nb0nb0z8.jpg"></div><div class="author-info__name text-center">石海鹏</div><div class="author-info__description text-center">编程辅导&amp;交流</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">11</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">6</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://github.com/shihaipeng" target="_blank">github</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">石海鹏的网页</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">esp32学习笔记（四）</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-07-31</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/笔记/">笔记</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇为esp-now功能的讲解。回想前几天研究RainMaker平台的惨败和研究BLE的痛苦经历，相较而言这个就显得太简单了些。<br><a id="more"></a></p>
<h2 id="esp-now简介"><a href="#esp-now简介" class="headerlink" title="esp-now简介"></a>esp-now简介</h2><p>esp-now没记错的话是一种无连接的通讯方式，特点就是不需要连接、一个设备最多可以与20个设备通讯、单次最多发送250字节数据的一种临时通讯，最典型的应用就是帮助设备联网。比方说你有一个esp32需要连自家wifi，但事先不知道是多少，就可以用esp-now发送需要连接的wifi信息。想当初，我要搞一个智能家居的项目，当时就需要很多分模块和主模块之间进行信息传递。当时的想法是，在家正中间放一个中继器一样的东西，然后就可以把各个角落的传感器数据汇总发送到手机。考虑到每个传感器模块并不需要直接联网，而且只需要时不时发送少量数据，因此我便钦定esp-now为整个系统指定通讯方式。当然，我也不知道这样用规范不规范，总之有用就行。<br>要学的话直接看<a href="https://www.qutaojiao.com/23849.html" target="_blank" rel="noopener">这个</a>和<a href="https://demo-dijiudu.readthedocs.io/en/latest/api-reference/wifi/esp_now.html" target="_blank" rel="noopener">官方文档</a>。之所以觉得esp-now简单，是因为无论在esp32还是esp8266或其他，无论用Arduino框架还是IDF，要用的库函数长得一模一样。事实上对照着看教程和官方文档基本就能懂个七七八八，甚至不需要去翻看源码（虽然目前已经习惯这样做了）。如果不需要加密的话（我觉得真不需要，感觉没有实际需求），这个就更加简单了。<br>诚如官方文档，这个一共就3步，如果只需要接收而不用发送则省略第二步。</p>
<ol>
<li>初始化</li>
<li>添加目标设备</li>
<li>发送/接收数据<br>初始化如下：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化 ESP-NOW</span></span><br><span class="line">WiFi.mode(WIFI_STA);</span><br><span class="line"><span class="keyword">if</span> (esp_now_init() != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    Serial.println(<span class="string">"Error initializing ESP-NOW"</span>);</span><br><span class="line">&#125;</span><br><span class="line">esp_now_register_send_cb(OnDataSent); <span class="comment">// 按需添加回调</span></span><br><span class="line">esp_now_register_recv_cb(OnDataRecv); <span class="comment">// 按需添加回调</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果只需要接收，那么只用再补充接收数据的回调就行。如果需要发送数据，发送的回调也是可加可不加的，不过还是建议加上。回调写法如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnDataSent</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *peer_addr, <span class="keyword">esp_now_send_status_t</span> status)</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="comment">// peer_addr 发送目标的mac地址  status 状态</span></span><br><span class="line">    Serial.print(<span class="string">"Send status: "</span>);</span><br><span class="line">    Serial.println(status == ESP_NOW_SEND_SUCCESS ? <span class="string">"Delivery Success"</span> : <span class="string">"Delivery Fail"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据接收回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnDataRecv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *mac_addr, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *incomingData, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="comment">// mac_addr 发送方的mac地址  incomingData 内存形式的数据  len 数据字节数</span></span><br><span class="line">    RecvData_t msg;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;msg, incomingData, len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> macStr[<span class="number">18</span>];</span><br><span class="line">    Serial.print(<span class="string">"Get Data from: "</span>);</span><br><span class="line">    <span class="built_in">snprintf</span>(macStr, <span class="keyword">sizeof</span>(macStr), <span class="string">"%02x:%02x:%02x:%02x:%02x:%02x"</span>,</span><br><span class="line">            mac_addr[<span class="number">0</span>], mac_addr[<span class="number">1</span>], mac_addr[<span class="number">2</span>], mac_addr[<span class="number">3</span>], mac_addr[<span class="number">4</span>], mac_addr[<span class="number">5</span>]);</span><br><span class="line">    Serial.println(macStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我希望各位能明白<code>RecvData_t msg; memcpy(&amp;msg, incomingData, len);</code>这两句话是干啥的，之前ble的笔记里面好像也有写成这样的代码，当时没有细讲。感到陌生的主要原因还是平时刷题啊写作业啊都不会和内存打交道，导致一旦碰到一点点内存相关的就不明白了（我就是这样的）。这个得结合发送数据来讲。</p>
<p>发送数据之前，需要先添加目标设备。方法如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">esp_now_peer_info_t</span> peerInfo;</span><br><span class="line"><span class="built_in">memcpy</span>(peerInfo.peer_addr, mac, <span class="number">6</span>);</span><br><span class="line">peerInfo.channel = <span class="number">0</span>;</span><br><span class="line">peerInfo.encrypt = <span class="literal">false</span>;</span><br><span class="line">peerInfo.ifidx = WIFI_IF_ST</span><br><span class="line"><span class="keyword">if</span> (esp_now_add_peer(&amp;peerInfo) != ESP_OK)</span><br><span class="line">&#123;</span><br><span class="line">    Serial.println(<span class="string">"Failed to add peer"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这一段一点都不用改，照抄就行。channel = 0建议不要改，懒得折腾。encrypt = false建议不改，懒得折腾加密，何必嘛。具体是什么自己看esp_now_peer_info_t的注释。顺便提醒一点，esp_now.h里面还有如下的一些特别方便的函数（当时没注意看，以为没有，还是自己乱写的）。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">esp_err_t</span> esp_now_del_peer(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *peer_addr) <span class="comment">// delete</span></span><br><span class="line"><span class="keyword">esp_err_t</span> esp_now_mod_peer(<span class="keyword">const</span> <span class="keyword">esp_now_peer_info_t</span> *peer); <span class="comment">// modify</span></span><br><span class="line"><span class="keyword">esp_err_t</span> esp_now_get_peer(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *peer_addr, <span class="keyword">esp_now_peer_info_t</span> *peer); <span class="comment">// 找到就放到传入的指针里</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">esp_now_is_peer_exist</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *peer_addr)</span></span></span><br><span class="line"><span class="function">esp_err_t <span class="title">esp_now_get_peer_num</span><span class="params">(<span class="keyword">esp_now_peer_num_t</span> *num)</span> <span class="comment">// 获取设备总数</span></span></span><br></pre></td></tr></table></figure></p>
<p>接下来是发送数据。发送也很简单<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SendData_t <span class="title">myData</span><span class="params">(&#123;aargs&#125;)</span></span>;</span><br><span class="line">esp_now_send(mac, (<span class="keyword">uint8_t</span> *)&amp;myData, <span class="keyword">sizeof</span>(myData));</span><br></pre></td></tr></table></figure></p>
<p>注意，发送方和接收方需要事先约定好一个共同的数据结构。也就是说，发送方的SendData_t就是接收方的RecvData_t，当然变量名随便乱取都可以。一般而言，为了一次发送多个数据，都是这样搞的：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">char</span> b;    </span><br><span class="line">    <span class="keyword">float</span> c;</span><br><span class="line">    ···</span><br><span class="line">&#125; SendData_t;</span><br></pre></td></tr></table></figure></p>
<p>注意，一定不要用string这种内存不固定的数据类型。如果要传字符串，这里有一个取巧的方法，我当时就是这么解决的。当时的实际需求是每个分设备要通过esp-now传两个标识符和一个长度不固定的json字符串（由于各个传感器需要测量的东西不同，于是统一以json字符串形式发送传感器数据）。于是我就写成了这样：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> // 主机</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;         <span class="comment">// 传入设备的ID</span></span><br><span class="line">    <span class="keyword">int</span> type;       <span class="comment">// 1 普通消息 2 其他消息</span></span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">256</span>]; <span class="comment">// 保证一定大于250</span></span><br><span class="line">&#125; RecvData_t;       <span class="comment">//接收的数据类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> // 分传感器端</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;         <span class="comment">// 本机的ID</span></span><br><span class="line">    <span class="keyword">int</span> type;       <span class="comment">// 1 普通消息 2 其他消息</span></span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">230</span>]; <span class="comment">// 保证一定小于250</span></span><br><span class="line">&#125; SendMsg_t;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送数据时</span></span><br><span class="line">SendMsg_t msg;</span><br><span class="line">msg.id = ID;</span><br><span class="line">msg.type = type;</span><br><span class="line"><span class="built_in">memcpy</span>(msg.data, str.c_str(), str.size());</span><br><span class="line">esp_now_send(HostMacAdress, (<span class="keyword">uint8_t</span> *)&amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"><span class="comment">// 接收数据时</span></span><br><span class="line">RecvData_t msg;</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;msg, incomingData, len); <span class="comment">// 直接这么写</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> json = msg.data;</span><br></pre></td></tr></table></figure></p>
<p>然后确保字符串长度不超过230就行（一般而言也不会吧）。</p>
<p>最后是接收数据。一接收到数据，就会调用esp_now_register_recv_cb设置的回调，在这里面处理接收到的数据就行。顺带提两点。一是接收和发送的回调是可以删除的，调用esp_now_unregister_recv_cb就行。二是如果需要对数据进行极大量的操作或需要延时，不要写在回调里面。应当尽量确保回调函数能快速结束。尤其是delay等操作，一定不要在回调里面写。事实上就实践而言，日常写不了那种过于复杂以至于没有用延时却在回调里面卡死了的代码。我当时在回调里面用stringstream处理超长字符串，还顺带各种类型转换和字串查找都没有问题。</p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/esp32/">esp32</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2023/09/02/oneos体验（一）/"><i class="fa fa-chevron-left">  </i><span>oneos体验（一）</span></a></div><div class="next-post pull-right"><a href="/2022/07/30/esp32学习笔记（三）/"><span>esp32学习笔记（三）</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="lv-container" data-id="city" data-uid="MTAyMC80MjExNS8xODY2Mg=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By 石海鹏</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">随便写的，不要在意....</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>